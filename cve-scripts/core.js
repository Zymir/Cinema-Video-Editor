var lineaVideo;
var lineaAudio;
var biblioteca;
$(function() {

	/**********INI**********/

	resizePlayer();
	makeBiblioteca();
	biblioteca.print();
	lineaVideo = new cveLineaVideo();
	lineaAudio = new cveLineaAudio();
	
		$('#container').addClass('visible');
	/**********EVENTS**********/
	//Resize event		
	$(window).resize(function() {
		resizePlayer();
	});
	
	
	$('#headerBar').click(function(){
		hideTitle();
	});
			
	/*EVENTS*/		

	/*Bilbioteca DRAG*/
	$('.bibliotecaElement').live('dragstart', function(ev){
		$(this).addClass("dragging");
		console.log('dragstart');
		var dt = ev.originalEvent.dataTransfer;  
		var idBiblioteca = $(this).attr('id').split('_')[1];
        dt.setData("Text", idBiblioteca);  
		console.log(idBiblioteca);
        return true;  
	});
	$('.bibliotecaElement').live('dragend', function(ev){
		$(this).removeClass("dragging");
	});
	
 	/*AUDIO DROP*/
	$('#audioTimeLine').live('dragover', function(ev) {  
        //no cancela el drop
        return false;  
    })  
    
	$('#audioTimeLine').live('drop', function(ev) {
		console.log('drop');	
        var dt = ev.originalEvent.dataTransfer;  
		var idBiblioteca = dt.getData('Text');  
	
		/*Lets do the magic*/
		
		var item = biblioteca.get(idBiblioteca);
		if(item.type() == 2){
			var index = lineaAudio.getIndex();
			console.log("Indice de lineaAudio: "+index);
			var startingIn="0";
			if (index > 0){
				startingIn = parseInt(lineaAudio.get(index-1).entrada)+parseInt(lineaAudio.get(index-1).duracion);
			}
			
			var obj = new cveObjectLinea(startingIn, 10,1,item.type(),item,index);
			lineaAudio.add(obj);
			var duracionEnPixeles = '100';
			
			$(this).append(item.printForLinea(duracionEnPixeles,index));
			
		}else{
			alert("Aquí solo puede ir Audio, porfavor arrastra el objeto a la linea de arriba");
		}

	});
	
	/*VIDEO DROP*/
	$('#videoTimeLine').live('dragover', function(ev) {  
        //no cancela el drop
        return false;  
    }) 
	$('#videoTimeLine').live('drop', function(ev) {
		console.log('drop');	
        var dt = ev.originalEvent.dataTransfer;  
		var idBiblioteca = dt.getData('Text');  
		
		/*Lets do the magic*/
		
		var item = biblioteca.get(idBiblioteca);
		if(item.type() != 2){
			miDuracion = 2;
		
			var duracionEnPixeles = miDuracion*10;
			console.log("La duracion en pixeles: "+duracionEnPixeles);
			
			//Aumentamos width para que sea infinita
		
			var actualWidth = $(this).innerWidth();
			console.log(actualWidth);
			
			var calculatedWidth = parseInt(actualWidth)+parseInt(duracionEnPixeles);
		
			console.log(calculatedWidth);
			$(this).css('width',calculatedWidth+'px');		
					
			//vamos a crear el objeto y se lo pasamos a openPropiedades(obj)
			var index = lineaVideo.getIndex();
			console.log("Indice de lineaVideo: "+index);
			var startingIn="0";
			if (index > 0){
				startingIn = parseInt(lineaVideo.get(index-1).entrada)+parseInt(lineaVideo.get(index-1).duracion);
			}
			
			//Si es un texto pasamos un NEW.
			if(item.type()!=0){
				var obj = new cveObjectLinea(startingIn, miDuracion,1,item.type(),item,index);
			}else{
				var index2 = biblioteca.getIndex();
				var text = new cveText("Nuevo texto","Arial","12","ffffff","000000",index2);
				
				var obj = new cveObjectLinea(startingIn, miDuracion,1,item.type(),text,index);
			}
			
			
			
			lineaVideo.add(obj);
			
			console.log(item.printForLinea(duracionEnPixeles,index));
			$(this).append(item.printForLinea(duracionEnPixeles,index));
			
			openPropiedades(obj);
			var html = obj.obj.print();
			$('#player').html(html);
		
		}else{
			alert("El audio se arrastra a la barra de abajo");
		}
		
        return false;  
    }); 
    
    $('.itemEnLinea').live('click', function(ev) {
		//montamos el objeto para mostrar propiedades
		var idLineaVideo = $(this).attr('id').split('_')[1];
		var obj = lineaVideo.get(idLineaVideo)
		openPropiedades(obj);
		var html = obj.obj.print();
		$('#player').html(html);
	});
	
	/*UPLOADER*/
	
	var holder = document.getElementById('uploader');
	holder.ondrop = function (e) {  

		$('#uploader').removeClass('hover');
		e.stopPropagation();
		e.preventDefault();
		for (var i = 0; i < e.dataTransfer.files.length; i++){
		
			var file = e.dataTransfer.files[i],reader = new FileReader();
			var reader = new FileReader();
			reader.onload = function (event) {
				var img = new Image();
				img.src = event.target.result;
				// note: no onload required since we've got the dataurl...I think! :)
				index = biblioteca.getIndex();
				var image = new cveImage(img.src,550,412,index);
				biblioteca.add(image);
				var objHTML = $('#ulBiblioteca').append(image.printForBiblioteca());
			}
			reader.readAsDataURL(file);
		}
		return false;

    }  
	$('#uploader').live('dragover', function(ev) {  
	$(this).addClass('hover');
        //no cancela el drop
        return false;  
    })  
	$('#uploader').live('dragleave', function(ev) {  
		$(this).removeClass('hover');
        //no cancela el drop
        return false;  
    })  
	
	/*CONTROLLS */
	$('#plauItBaby').live('click', function() {  
		renderPlay();
        return false;  
    })  
	$('#stopItBaby').live('click', function() {  
		renderStop();
        return false;  
    }) 
    $('#soundItBaby').live('click', function() { 
    	$(this).hide();
    	$('#mouteItBaby').show();
		renderMute();
        return false;  
    }) 
    $('#mouteItBaby').live('click', function() {  
   		 $(this).hide();
    	$('#soundItBaby').show();
		renderMute();
        return false;  
    }) 
    
    $('#botonVimeo').live('click',function(){
    	index = biblioteca.getIndex();
		var video = new cveVimeo($("#vimeoInput").val(),300,300,index);
		biblioteca.add(video);
		$('#ulBiblioteca').append(video.printForBiblioteca());
    })

	/*END EVENTS AFETER INTERFACE INIT*/
});

function resizePlayer(){
	var width = $('#container').innerWidth();	
	if(width > 1124){
		var playerNewWidth = width-500-4-550;//restamos las barras laterales, los bordes, el largo del player
		$('#player').css('width',550);
		$('#player').css('height',412);

	}else{
		var playerNewWidth =72;//36 margin como minimo
		
		var newWidth = width-500-4-72;
		var newHeight = (newWidth/4)*3;
		$('#player').css('width',newWidth);
		$('#player').css('height',newHeight);
		
	}
	
	$('#player').css('margin-left',playerNewWidth/2);
}
function hideTitle(){
	$('#title').toggle();
	$('footer').toggle();
}

function makeBiblioteca(){

	biblioteca  = new cveBiblioteca();
	
	var index = biblioteca.getIndex();
	var text = new cveText("Nuevo texto","Arial","12px","ffffff","000000",index);
	biblioteca.add(text);
	$('#ulBiblioteca').append(text.printForBiblioteca());	
	
	index = biblioteca.getIndex();
	var audio = new cveAudio("cve-files/audio/cats.mp3",index);
	biblioteca.add(audio);
	$('#ulBiblioteca').append(audio.printForBiblioteca());
	
	index = biblioteca.getIndex();
	var video = new cveVideo("cve-files/video/cats.mp4",300,300,index);
	biblioteca.add(video);
	$('#ulBiblioteca').append(video.printForBiblioteca());
	
	/*
	index = biblioteca.getIndex();
	var image = new cveImage("cve-files/image/image001.jpg",550,412,index);
	biblioteca.add(image);
	var objHTML = $('#ulBiblioteca').append(image.printForBiblioteca());
	
	index = biblioteca.getIndex();
	var image = new cveImage("cve-files/image/image002.jpg",550,412,index);
	biblioteca.add(image);
	var objHTML = $('#ulBiblioteca').append(image.printForBiblioteca());

	index = biblioteca.getIndex();
	var image = new cveImage("cve-files/image/image003.jpg",550,412,index);
	biblioteca.add(image);
	var objHTML = $('#ulBiblioteca').append(image.printForBiblioteca());
	
	index = biblioteca.getIndex();
	var image = new cveImage("cve-files/image/image004.jpg",550,412,index);
	biblioteca.add(image);
	var objHTML = $('#ulBiblioteca').append(image.printForBiblioteca());	
*/
}
function openPropiedades(obj){
	/*console.log("Estamos abriendo las propiedades de este objeto:");
	console.log(obj);
	$('#propiedadesBox').append(obj.printPropiedades());*/
	
	
	// Los objetos que le pasamos deberían ser del tipo cveObjectLinea, ahora se pasan los objetos de cada una de las clases.
	this.obj = obj;
	
	$('#propiedadesBox').empty().append('Entrada: <span></span><input id="entrada" disabled="disabled" type="text" value="'+obj.entrada+'"/>s<br/>');
	$('#propiedadesBox').append('Duraci&oacute;n: <span></span><input id="duracion" type="text" value="'+obj.duracion+'"/>s<br/>');
	$('#propiedadesBox').append('<input id="transicion" type="number" step="1" min="1" max="3" value="'+obj.transicion+'" style="display:none;"/><br/>');
	
	if (obj.type==0){
		
		$('#propiedadesBox').append('<br/>Texto: <textarea id="propiedadesTexto" type="text" value="'+obj.obj.text+'">'+obj.obj.text+'</textarea><br/>');
		$('#propiedadesBox').append('Fuente: <select id="font"><option value="Arial">Arial</option><option value="Verdana">Verdana</option><option value="Times New Roman">Times New Roman</option></select><br/>');
		$('#propiedadesBox').append('Tama&ntilde;o: <span>5px</span><input id="propiedadesSize" type="range" min="5" max="100" value="'+obj.obj.size+'"/><span>100px</span><br/>');
		
		$('#propiedadesBox').append('Color:<br/><input id="colorTexto" class="Multiple" type="text" value="'+obj.obj.color+'" /><br />');
		$('#propiedadesBox').append('Color de fondo:<br/><input id="fondoTexto" class="Multiple" type="text" value="'+obj.obj.background+'" /><br />');
		
		colorPicker();
	}
	//Boton de guardar: Tiene que almacenar todo lo anterior en sus respectivos lugares, llamar a una funcion aparte pasandole los datos por $_POST y que esta se encargue de guardarlo.
	$('#propiedadesBox').append('<button onclick="savePropiedades(obj)">Guardar Cambios</button>');
	
	
	/*Recuperar largo de la linea de tiempo*/
	var duracionEnPixeles = obj.duracion*10;
	var actualWidth = $("#videoTimeLine").innerWidth();
	var calculatedWidth = parseInt(actualWidth)+parseInt(obj.duracionEnPixeles);
	$("#videoTimeLine").css('width',calculatedWidth+'px');	
}

function savePropiedades(obj){

	//Funcion que guarda todo lo que le pasan distinguiendo mediante uno de los parametros pasados si se trata de un texto o no mediante un parametro isText=0|1 donde 0 es que no y 1 que si.
	obj.entrada=document.getElementById("entrada").value;
	obj.duracion=document.getElementById("duracion").value;
	obj.transicion=document.getElementById("transicion").value;
	
	if (obj.type==0){
		obj.obj.text=document.getElementById("propiedadesTexto").value;
		obj.obj.font=document.getElementById("font").value;
		obj.obj.size=document.getElementById("propiedadesSize").value;
		obj.obj.color=document.getElementById("colorTexto").value;
		obj.obj.background=document.getElementById("fondoTexto").value;
	}
	
	var duracionEnPixeles = obj.duracion*10;
	console.log("La duracion en pixeles: "+duracionEnPixeles+" para el item: "+obj.index);
	$("#lineaVideo_"+obj.index).width(duracionEnPixeles);
}
/** INICIO Color Picker **/
function colorPicker(){
      
  $(document).ready(
    function()
    {
      $('.Multiple').jPicker();
	});
}
/** FIN Color Picker **/